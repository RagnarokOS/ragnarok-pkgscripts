#!/bin/ksh

# $Ragnarok: pkg_install,v 1.10 2025/09/16 16:06:54 lecorbeau Exp $
# Install or update "third party" package(s).

# Install packages.
inst_pkg() {
	local _pkgs

	set -A _pkgs -- "$@"

	# It's possible to just install the whole @local set in one go.
	if [[ ${_pkgs[*]} == @local ]]; then
    		/usr/bin/emerge -av --oneshot @local
	else
		for _pkg in "${_pkgs[@]}"; do
			if ! grep -q "${_pkg}" /etc/portage/sets/local; then
				printf '%s\n' "$_pkg" >> /etc/portage/sets/local
			fi
		done

		emerge -av --oneshot "${_pkgs[@]}"
	fi
}

# Update pkgs.
upd_pkg() {
	/usr/bin/emerge -avuDN --with-bdeps=y --oneshot @local
}

# Delete pkg(s)
rm_pkg() {
	local _pkgs

	set -A _pkgs -- "$@"
	
	if [[ ${_pkgs[*]} -eq 0 ]]; then
		printf '%s\n' "No package name provided..."
		exit 1
	fi

	# shellcheck disable=SC2154
	# Cleanup the set.
	for _pkg in "${_pkgs[@]}"; do
		sed -i	-e "s#${_pkg}##g" /etc/portage/sets/local
		sed -i	-e'/^[[:space:]]*$/d' /etc/portage/sets/local
	done

	# run --depclean against those packages.
	/usr/bin/emerge -av --depclean "${_pkgs[@]}"
}

# TODO: use getopts instead of case.
case "$1" in
	-d)	rm_pkg "$@"
		;;
	-p)	/usr/bin/emerge -av --oneshot --pretend "$@"
		;;
	-u)	upd_pkg
		;;
	-up|-pu)
		/usr/bin/emerge -avuDN --with-bdeps=y --oneshot --pretend "$@"
		;;
	*)	inst_pkg "$@"
		;;
esac
